# WebRTC 聊天功能测试指南

## 🧪 测试 WebRTC P2P 聊天功能

### 单设备测试（推荐开始测试）

1. **打开两个浏览器标签页**
   - 在同一浏览器中打开两个标签页，都访问 `http://localhost:3000`

2. **创建房间**
   - 在第一个标签页点击"创建房间"
   - 选择"公开房间"或"加密房间"
   - 公开房间：生成6位数字房间号（例如：123456）
   - 加密房间：生成4位数字房间号（例如：1234）并设置密码
   - 等待连接状态变为"已连接"

3. **加入房间**
   - 在第二个标签页点击"加入房间"
   - 输入房间号，系统自动识别房间类型
   - 4位数字：自动显示为加密房间，需要输入密码
   - 6位数字：自动显示为公开房间，直接加入
   - 点击"加入房间"按钮

4. **测试聊天**
   - 在任一标签页发送消息
   - 验证消息是否在另一个标签页实时显示
   - 检查在线人数是否显示为"2人在线"

### 多设备测试

1. **不同设备**
   - 在手机、平板、其他电脑上打开应用
   - 使用相同的房间号加入

2. **不同网络**
   - 测试在不同WiFi网络下的连接
   - 测试移动网络与WiFi之间的连接

### 加密房间测试

1. **创建加密房间**
   - 点击"创建房间" → 选择"加密房间"
   - 系统生成4位数字房间号（例如：1234）
   - 设置密码（例如：mypassword123）
   - 确认房间创建成功

2. **正确密码加入**
   - 在另一个标签页点击"加入房间"
   - 输入4位房间号，系统自动识别为加密房间
   - 密码输入框自动显示，输入正确的密码
   - 验证能够成功连接和聊天

3. **错误密码测试**
   - 在新标签页点击"加入房间"
   - 输入4位房间号，系统自动识别为加密房间
   - 输入错误的密码
   - 验证连接失败（应该无法连接到房间）

4. **房间号格式测试**
   - 输入无效格式的房间号（如：12345、abc123）
   - 验证系统显示格式错误提示
   - 确认只有4位和6位数字被接受

### 功能验证清单

#### ✅ 房间类型
- [ ] 公开房间创建（6位房间号）
- [ ] 加密房间创建（4位房间号）
- [ ] 输入6位房间号自动识别为公开房间
- [ ] 输入4位房间号自动识别为加密房间并显示密码框
- [ ] 房间类型标签正确显示（🌐公开房间 / 🔐加密房间）
- [ ] 正确密码可以加入加密房间
- [ ] 错误密码无法加入加密房间
- [ ] 密码可见性切换功能正常
- [ ] 房间号格式验证正确

#### ✅ 连接状态
- [ ] 创建房间时显示"正在连接..."
- [ ] 连接成功后显示绿色圆点和"已连接"
- [ ] 显示正确的在线人数

#### ✅ 消息功能
- [ ] 发送文本消息
- [ ] 消息实时传输（无明显延迟）
- [ ] 消息显示正确的时间戳
- [ ] 用户消息和其他人消息样式不同

#### ✅ 用户管理
- [ ] 新用户加入时更新在线人数
- [ ] 用户离开时更新在线人数
- [ ] 消息历史同步（新用户能看到之前的消息）

#### ✅ 界面交互
- [ ] 连接中时输入框被禁用
- [ ] 连接成功后可以正常发送消息
- [ ] 返回首页功能正常

### 常见问题排查

#### 连接失败
- 检查网络连接
- 尝试刷新页面重新连接
- 检查浏览器控制台是否有错误信息

#### 消息不同步
- 确认两个设备都显示"已连接"状态
- 检查房间号是否输入正确
- 尝试重新加入房间

#### 性能问题
- WebRTC 是 P2P 连接，性能取决于设备间的网络质量
- 在同一局域网内测试效果最佳
- 跨网络连接可能需要更多时间建立

### 技术细节

#### WebRTC 连接过程
1. **信令**: 使用 Nostr 网络进行初始握手
2. **ICE**: 自动进行 NAT 穿透
3. **DTLS**: 建立加密的数据通道
4. **数据传输**: 直接 P2P 消息传输

#### 安全性
- 所有消息都经过端到端加密
- 不经过中央服务器
- 房间号可作为额外的访问控制

### 开发调试

#### 浏览器控制台
打开开发者工具查看详细日志：
```javascript
// 查看 WebRTC 连接状态
console.log('WebRTC 连接信息');

// 查看 Trystero 调试信息
localStorage.setItem('debug', 'trystero:*');
```

#### 网络监控
- 使用浏览器的网络面板监控 WebRTC 流量
- 检查 ICE 候选者和连接状态

---

## 🎯 测试成功标准

如果以下功能都正常工作，说明 WebRTC 集成成功：

1. ✅ 能够创建和加入房间
2. ✅ 实时消息传输无延迟
3. ✅ 多用户同时在线
4. ✅ 连接状态正确显示
5. ✅ 消息历史正确同步
6. ✅ 用户离开/加入正确处理

测试愉快！🚀
